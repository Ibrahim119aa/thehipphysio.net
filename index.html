<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Rehab Plans</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa;
        }

        .card-title {
            margin-bottom: var(--bs-card-title-spacer-y);
            color: var(--bs-card-title-color);
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1.4;
        }

        p.planDuration {
            background: #f4f4f4;
            max-width: fit-content;
            padding: 4px 10px;
            font-weight: 700;
        }

        .plan-card {
            border-radius: 0px;
            transition: all 0.3s ease;
            border: 1px solid black;
        }

        .plan-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
        }

        .plan-price {
            font-weight: bold;
            color: #fff;
            background: #11989d;
            max-width: fit-content;
            padding: .25rem .5rem;
            font-size: .875rem;
        }

        .plan-type {
            font-size: 0.9rem;
            text-transform: capitalize;
        }

        .plan-desc {
            font-size: 0.9rem;
            max-height: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        section.online_rehaps_sec {
            background: #11989d;
            padding: 130px 15px;
        }

        .banner_heading {
            text-align: center;
            max-width: 815px;
            margin: 0px auto;
            color: #fff;
        }

        .banner_heading h1 {
            padding-top: 0;
            padding-bottom: 0;
            font-size: 3.9rem;
            text-decoration: none;
            display: block;
            position: static;
        }

        .banner_heading p {
            font-size: 20px;
            line-height: 30px;
            margin-top: 40px;
        }

        .buy_nowBtn {
            background: #333;
            border-radius: 5px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            color: #fff;
            font-size: 16px;
            min-width: 160px;
            padding: 8px 20px;
            max-width: fit-content;
            border: none;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .buy_nowBtn:hover {
            background: #222;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, .1);
            border-radius: 50%;
            border-top-color: #11989d;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
    </style>
</head>

<body>
    <section class="online_rehaps_sec">
        <div class="container">
            <div class="row">
                <div class="banner_heading">
                    <h1>Online Rehab<br> Programmes</h1>
                    <p>Online hip physiotherapy programmes. Crafted to help you achieve full function regardless of your
                        stage of recovery.</p>
                </div>
            </div>
        </div>
    </section>
    <div class="container py-5">
        <h1 class="text-center mb-4">Available Rehab Plans</h1>
        <div id="loading-message" class="text-center mb-4">
            <div class="loading-spinner"></div>
            <p class="mt-2">Loading plans...</p>
        </div>
        <div id="error-message" class="alert alert-info d-none"></div>
        <div id="plans-container" class="row g-4">
            <!-- Plans will load here -->
        </div>
    </div>

    <script>
        // Static JSON data (fallback)
        const staticPlans = {
            "success": true,
            "message": "Rehab plans fetched successfully",
            "data": [
                {
                    "_id": "689883f20ecbb1a9b6173049",
                    "name": "Hip Replacement",
                    "description": "this is hip replacement",
                    "price": 90,
                    "planType": "paid",
                    "phase": "phase 2",
                    "weekEnd": null,
                    "weekStart": null,
                    "totalWeeks": 2,
                    "categories": [
                        { "_id": "68962d5e50cb817e7236b1d4", "title": "Hip replacement" }
                    ],
                    "planDurationInWeeks": 3
                },
                {
                    "_id": "68a2629edf4d852962627253",
                    "name": "Full Exercise Plan",
                    "description": "This is Full Exercise Plan",
                    "price": 265,
                    "planType": "paid",
                    "phase": "Phase 1",
                    "weekEnd": 8,
                    "weekStart": 3,
                    "totalWeeks": 2,
                    "categories": [
                        { "_id": "68962d9350cb817e7236b1d7", "title": "Shoulder plan" }
                    ],
                    "planDurationInWeeks": 3
                },
                {
                    "_id": "68b839d214206109ac768593",
                    "name": "FAIS Post Surgery Rehab Plan - Early Phase",
                    "description": "PHASE 1 (Early) - Taking you through from week 1 post surgery...",
                    "price": 125,
                    "planType": "paid",
                    "phase": "phase 1",
                    "weekStart": 3,
                    "weekEnd": 5,
                    "totalWeeks": 2,
                    "categories": [
                        { "_id": "68b8398414206109ac76858f", "title": "Post surgery" }
                    ],
                    "planDurationInWeeks": 2
                }
            ]
        };

        async function fetchRehabPlans() {
            const container = document.getElementById("plans-container");
            const loadingMessage = document.getElementById("loading-message");
            const errorMessage = document.getElementById("error-message");

            try {
                const response = await fetch("https://80fe4d21a9c5.ngrok-free.app/api/rehab-plans", {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true' // Skip ngrok warning page
                    }
                });

                loadingMessage.classList.add('d-none');

                // Check if response is JSON
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    throw new Error("Server returned non-JSON response (likely HTML error page)");
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success && result.data && result.data.length > 0) {
                    renderPlans(result.data);
                    errorMessage.classList.add('d-none');
                } else {
                    throw new Error("No plans available from API");
                }
            } catch (error) {
                console.warn("API failed, showing static data instead:", error.message);
                loadingMessage.classList.add('d-none');
                errorMessage.textContent = `Unable to load live data (${error.message}). Showing example plans instead.`;
                errorMessage.classList.remove('d-none');
                renderPlans(staticPlans.data);
            }
        }

        function renderPlans(plans) {
            const container = document.getElementById("plans-container");
            container.innerHTML = "";

            plans.forEach(plan => {
                const categories = plan.categories?.map(c => c.title).join(", ") || "-";
                const planHTML = `
              <div class="col-md-4">
                <div class="card plan-card h-100 shadow-sm">
                  <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${plan.name}</h5>
                    <p class="planDuration">Weeks: ${plan.planDurationInWeeks || plan.totalWeeks || "-"}</p>
                    <p class="plan-price">${plan.price}</p>
                    <p class="plan-type"><span style="font-weight: 700;">Type</span>: ${plan.planType}</p>
                    <p class="plan-type"><span style="font-weight: 700;">Phase</span>: ${plan.phase || "-"}</p>
                    <p class="plan-desc">${plan.description}</p>
                    <p class="plan-type"><span style="font-weight: 700;">Categories</span>: ${categories}</p>
                    <button class="buy_nowBtn" onclick="buyPlan('${plan._id}', '${plan.name.replace(/'/g, "\\'")}', ${plan.price})">Buy Now</button>
                  </div>
                </div>
              </div>
            `;
                container.innerHTML += planHTML;
            });
        }

        async function buyPlan(planId, planName, planPrice) {
            try {
                // Get the button that was clicked
                const buttons = document.querySelectorAll('.buy_nowBtn');
                let clickedButton = null;
                buttons.forEach(btn => {
                    if (btn.onclick && btn.onclick.toString().includes(planId)) {
                        clickedButton = btn;
                    }
                });

                // Show loading state
                if (clickedButton) {
                    clickedButton.textContent = 'Loading...';
                    clickedButton.disabled = true;
                }

                // Call backend API to create Stripe checkout session
                const response = await fetch('https://80fe4d21a9c5.ngrok-free.app/api/user/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({
                        planId: planId,
                        rehabPlanName: planName,
                        price: planPrice
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Redirect to Stripe checkout page
                // Check common response field names for the checkout URL
                const url = data.id || '';

                if (url) {
                    window.location.href = url;
                } else {
                    throw new Error('No checkout URL received from server');
                }
                console.log(data);

            } catch (error) {
                console.error('Checkout error:', error);
                alert('Failed to initiate checkout. Please try again.\n\nError: ' + error.message);

                // Reset button state
                const buttons = document.querySelectorAll('.buy_nowBtn');
                buttons.forEach(btn => {
                    if (btn.disabled) {
                        btn.textContent = 'Buy Now';
                        btn.disabled = false;
                    }
                });
            }
        }

        // Run on page load
        fetchRehabPlans();
    </script>

</body>

</html>